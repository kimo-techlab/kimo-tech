<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard | KIMO TECH</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<style>

body{
  margin:0;
  font-family:'Cairo',sans-serif;
  background:linear-gradient(135deg,#1303fa,#fcfcfc);
  color:#030303;
}

.container{
  max-width:1200px;
  margin:40px auto;
  padding:20px;
}

h1{
  text-align:center;
  margin-bottom:40px;
  font-weight:900;
  letter-spacing:1px;
}

.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:40px;
}

.card{
  background:linear-gradient(135deg,#639ed4,#524a68);
  padding:25px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(34, 29, 29, 0.4);
  text-align:center;
  transition:.3s;
}

.card:hover{
  transform:translateY(-5px);
}

.filters{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:25px;
}

select,input{
  padding:10px;
  border-radius:10px;
  border:none;
  outline:none;
}

.order-card{
  background:#ffffff;
  color:#111;
  padding:20px;
  border-radius:16px;
  margin-bottom:15px;
  box-shadow:0 6px 15px rgba(0,0,0,.2);
  transition:.2s;
}

.order-card:hover{
  transform:scale(1.02);
}

.status{
  padding:6px 14px;
  border-radius:30px;
  font-size:12px;
  font-weight:bold;
  display:inline-block;
}

.pending{
  background:#facc15;
  color:#000;
}

.shipped{
  background:#38bdf8;
  color:#000;
}

.completed{
  background:#22c545;
  color:#fff;
}

.order-id{
  font-size:12px;
  color:#666;
  margin-bottom:5px;
}

/* Toast Container */
#toastContainer{
  position:fixed;
  top:20px;
  left:20px;
  z-index:99999;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* Toast */
.toast{
  background:#111827;
  color:#fff;
  padding:12px 18px;
  border-radius:10px;
  min-width:220px;
  box-shadow:0 5px 20px rgba(0,0,0,.4);
  animation:slideIn .4s ease;
  font-size:14px;
}

.toast.success{
  background:#16a34a;
}

.toast.error{
  background:#dc2626;
}

@keyframes slideIn{
  from{transform:translateX(-30px);opacity:0;}
  to{transform:translateX(0);opacity:1;}
}
</style>
</head>


<body>



<div class="container">

<div style="display:flex;justify-content:space-between;align-items:center;">
  <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… KIMO ğŸ‘‘</h1>
  <button onclick="toggleTheme()" style="padding:8px 15px;border:none;border-radius:8px;cursor:pointer;">
    ğŸŒ™ Toggle Mode
  </button>
</div>


<div class="dashboard">
  <div class="card">
    <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
    <h2 id="totalOrders">0</h2>
  </div>

  <div class="card">
    <h3>Pending</h3>
    <h2 id="pendingCount">0</h2>
  </div>

  <div class="card">
    <h3>Completed</h3>
    <h2 id="completedCount">0</h2>
  </div>

  <div class="card">
    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h3>
    <h2 id="totalRevenue">0 EGP</h2>
  </div>
</div>

<div class="filters">
    <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„">
  <select id="statusFilter">
    <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
    <option value="pending">Pending</option>
    <option value="shipped">Shipped</option>
    <option value="completed">Completed</option>
  </select>

  <input type="date" id="fromDate">
  <input type="date" id="toDate">

  <button onclick="loadOrders()">ÙÙ„ØªØ±Ø©</button>
  <button onclick="exportExcel()">ØªØµØ¯ÙŠØ± Excel</button>
</div>

<div id="ordersContainer"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { 
  getFirestore,
  collection,
  getDocs,
  doc,
  deleteDoc,
  onSnapshot,
  updateDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA2ff2ZaA-Xb_zQcVSUDaERS-glaFFR0TY",
  authDomain: "kimo-tech-store-962df.firebaseapp.com",
  projectId: "kimo-tech-store-962df",
  storageBucket: "kimo-tech-store-962df.firebasestorage.app",
  messagingSenderId: "845478890277",
  appId: "1:845478890277:web:3cdd3328bde1b5b9dda8cc"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

import { getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

let currentRole = null;

onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.href = "admin-login.html";
    return;
  }

  const userDoc = await getDoc(doc(db, "users", user.uid));

  if(userDoc.exists()){
    currentRole = userDoc.data().role;
  }
});

/* ğŸ” Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© */
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "admin-login.html";
  }
});



/* ================= ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ================= */

const audio = new Audio("notification.mp3");
document.addEventListener("click", () => {
  audio.play().then(()=> audio.pause());
},{ once:true });

onSnapshot(collection(db,"orders"), (snapshot)=>{
  snapshot.docChanges().forEach(change=>{
    if(change.type === "added"){

      audio.play();
       showToast("Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØµÙ„ ğŸ”¥","success");
      loadOrders();
    }
  });
});

/* ================= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ================= */

let chartInstance = null;
function animateCounter(id, target){
  let start = 0;
  const duration = 800;
  const increment = target / (duration / 16);

  const element = document.getElementById(id);

  const counter = setInterval(()=>{
    start += increment;
    if(start >= target){
      start = target;
      clearInterval(counter);
    }
if(id === "totalRevenue"){
  element.innerText = Math.floor(start) + " EGP";
}else{
  element.innerText = Math.floor(start);
}  },16);
}

let chart;

function updateChart(revenue, pending, completed){

  const ctx = document.getElementById('salesChart').getContext('2d');

  if(chart) chart.destroy();

  chart = new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['Revenue','Pending','Completed'],
      datasets:[{
        data:[revenue, pending, completed],
        backgroundColor:[
          '#22c55e',
          '#facc15',
          '#38bdf8'
        ]
      }]
    },
    options:{
      plugins:{
        legend:{
          labels:{
            color:'#fff'
          }
        }
      }
    }
  });
}
window.loadOrders = async function(){

  const snapshot = await getDocs(collection(db,"orders"));

  const searchValue = document.getElementById("searchInput").value.toLowerCase();
  const statusFilter = document.getElementById("statusFilter").value;
  const fromDate = document.getElementById("fromDate").value;
  const toDate = document.getElementById("toDate").value;

  let total=0;
  let revenue=0;
  let pending=0;
  let completed=0;

  const container=document.getElementById("ordersContainer");
  container.innerHTML="";

  snapshot.forEach(docSnap=>{

    const data=docSnap.data();
    const id=docSnap.id;

    if(
  searchValue &&
  !data.customerName.toLowerCase().includes(searchValue) &&
  !data.phone.includes(searchValue)
) return;
    const status=data.status || "pending";

    let orderDate = data.createdAt ? data.createdAt.toDate() : null;

    if(statusFilter !== "all" && status !== statusFilter) return;

    if(fromDate && orderDate && orderDate < new Date(fromDate)) return;
    if(toDate && orderDate && orderDate > new Date(toDate)) return;

    total++;

    if(status==="pending") pending++;
    if(status==="completed"){
      completed++;
      revenue += data.total;
    }

    const card=document.createElement("div");
    card.className="order-card";
    card.style.cursor="pointer";

    card.onclick = () => openOrderDetails(data,id);

card.innerHTML=`
  <div class="order-id">Order ID: ${id.slice(0,8).toUpperCase()}</div>
  <strong>${data.customerName}</strong>
  <div class="status ${status}">${status.toUpperCase()}</div>
  <div>ğŸ’° ${data.total} EGP</div>
`;

    container.appendChild(card);
  });

animateCounter("totalOrders", total);
animateCounter("pendingCount", pending);
animateCounter("completedCount", completed);
animateCounter("totalRevenue", revenue);
updateChart(revenue, pending, completed);

}

/* ================= ØªØµØ¯ÙŠØ± Excel ================= */

window.exportExcel = async function(){

  const snapshot = await getDocs(collection(db,"orders"));
  let csv = "Name,Phone,Total,Status\n";

  snapshot.forEach(doc=>{
    const d = doc.data();
    csv += `${d.customerName},${d.phone},${d.total},${d.status || "pending"}\n`;
  });

  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "orders.csv";
  a.click();
}

/* ================= Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 30 ÙŠÙˆÙ… ================= */

async function autoDeleteOldOrders(){

  const snapshot = await getDocs(collection(db,"orders"));
  const now = new Date();

  snapshot.forEach(async (docSnap)=>{
    const data = docSnap.data();
    if(!data.createdAt) return;

    const orderDate = data.createdAt.toDate();
    const diff = (now - orderDate) / (1000*60*60*24);

    if(diff > 30){
      await deleteDoc(doc(db,"orders",docSnap.id));
    }
  });
}

autoDeleteOldOrders();
loadOrders();

showToast("Ø§Ù„ØªÙˆØ³Øª Ø§Ø´ØªØºÙ„Øª ğŸ”¥","success");

document.getElementById("searchInput").addEventListener("keyup", loadOrders);

window.openOrderDetails = function(data,id){

  let itemsHTML = "";
  data.items.forEach(p=>{
    itemsHTML += `
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
        <span>${p.name}</span>
        <span>${p.price} EGP</span>
      </div>
    `;
  });

  document.getElementById("popupContent").innerHTML = `
    <h3>${data.customerName}</h3>
    <p>ğŸ“ ${data.phone}</p>
    <p>ğŸ“ ${data.address}</p>
    <p>ğŸ’³ ${data.paymentMethod}</p>
    <hr>
    ${itemsHTML}
    <hr>
    <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${data.total} EGP</strong>

<div style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap;">
  <button onclick="changeStatus('${id}','pending')">Pending</button>
  <button onclick="changeStatus('${id}','shipped')">Shipped</button>
  <button onclick="changeStatus('${id}','completed')">Completed</button>
  <button onclick="printOrder()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
  ${currentRole === "owner" ? `<button onclick="deleteOrder('${id}')" style="background:#dc2626;color:#fff;">ğŸ—‘ Ø­Ø°Ù</button>` : ``}
</div>

  `;

  document.getElementById("orderPopup").style.display="flex";
}


window.changeStatus = async function(id,newStatus){

  try{

    await updateDoc(doc(db,"orders",id),{
      status:newStatus
    });

    showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ âœ…","success");

    loadOrders();
    closePopup();

  }catch(error){

    console.error(error);
    showToast("Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ âŒ","error");

  }
}


import { deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

window.deleteOrder = async function(id){

  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ØŸ")){
    return;
  }

  try{
    await deleteDoc(doc(db,"orders",id));
    showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ ğŸ—‘","success");
    closePopup();
    loadOrders();
  }catch(error){
    console.error(error);
    showToast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø­Ø°Ù âŒ","error");
  }
}

window.closePopup = function(){
  document.getElementById("orderPopup").style.display="none";
}

window.printOrder = function(){
  const content = document.getElementById("popupContent").innerHTML;

  const printWindow = window.open("", "", "width=800,height=600");
  printWindow.document.write(`
    <html>
    <head>
      <title>Print Order</title>
      <style>
        body{font-family:Arial;padding:20px;}

        .light-mode{
  background:#f8fafc;
  color:#111;
}

.light-mode .card{
  background:#ffffff;
  color:#111;
}
      </style>
    </head>
    <body>
      ${content}

      
    </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.print();
}

</script>
<canvas id="salesChart" style="max-width:400px;margin:30px auto;"></canvas>

<div id="orderPopup" style="
display:none;
position:fixed;
inset:0;
background:rgba(0,0,0,.6);
z-index:9999;
justify-content:center;
align-items:center;
">

<div style="
background:#fff;
width:90%;
max-width:600px;
padding:25px;
border-radius:20px;
position:relative;
">

<span onclick="closePopup()" 
style="position:absolute;top:10px;left:15px;cursor:pointer;font-size:18px;">
âœ–
</span>

<div id="popupContent"></div>

</div>
</div>

<script>
function toggleTheme(){
  document.body.classList.toggle("light-mode");
}
</script>
<div id="toastContainer"></div>

<script>

window.showToast = function(message,type="success"){

const container = document.getElementById("toastContainer");

  const toast = document.createElement("div");
  toast.className = "toast " + type;
  toast.innerText = message;

  container.appendChild(toast);

  setTimeout(()=>{
    toast.remove();
  },3000);
}
</script>
</body>
</html>
