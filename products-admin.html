<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª | KIMO TECH</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Cairo',sans-serif;
  background:linear-gradient(135deg,#1303fa,#fcfcfc);
}

.container{
  max-width:1100px;
  margin:40px auto;
  padding:20px;
}

h1{
  text-align:center;
  margin-bottom:30px;
  font-weight:900;
}

.top-bar{
  display:flex;
  justify-content:space-between;
  margin-bottom:20px;
  gap:10px;
}

button{
  padding:10px 18px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:bold;
}

.add-btn{background:#16a34a;color:#fff;}
.back-btn{background:#5726dc;color:#fff;}

.table{
  background:#ffffff;
  border-radius:20px;
  overflow:hidden;
  box-shadow:0 15px 40px rgba(0,0,0,.08);
}

.table-header,
.table-row{
  display:grid;
  grid-template-columns: 60px 80px 1fr 120px 120px 120px 200px;
  padding:12px;
  align-items:center;
}

.table-row:hover{
  background:#f8fafc;
  transform:scale(1.01);
}

img{
  transition:.3s;
}

.table-row:hover img{
  transform:scale(1.08);
}

.table-row{border-bottom:1px solid #eee;}
.table-row:last-child{border-bottom:none;}

.stock-yes{color:#16a34a;font-weight:bold;}
.stock-no{color:#dc2626;font-weight:bold;}

.badge{
  background:#facc15;
  color:#000;
  padding:3px 8px;
  font-size:11px;
  border-radius:20px;
  margin-right:8px;
  font-weight:bold;
}

.action-btn{
  padding:6px 10px;
  border-radius:8px;
  font-size:12px;
  margin-left:5px;
}

.edit{background:#facc15;}
.delete{background:#dc2626;color:#fff;}
.toggle{background:#38bdf8;}

.search{
  padding:10px;
  border-radius:10px;
  border:none;
  width:250px;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  justify-content:center;
  align-items:center;
}

.modal-content{
  background:#fff;
  padding:30px;
  border-radius:16px;
  width:400px;

  display:flex;
  flex-direction:column;
  gap:15px;

  max-height:90vh;      /* ÙŠØ®Ù„ÙŠÙ‡ Ù…Ø§ ÙŠØ¹Ø¯ÙŠØ´ Ø§Ù„Ø´Ø§Ø´Ø© */
  overflow-y:auto;      /* ÙŠØ¶ÙŠÙ Scroll */
}
.modal-content::-webkit-scrollbar{
  width:6px;
}
.modal-content::-webkit-scrollbar-thumb{
  background:#22c55e;
  border-radius:10px;
}
.modal input{
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
}

.toast{
  position:fixed;
  bottom:20px;
  left:20px;
  background:#111;
  color:#fff;
  padding:10px 15px;
  border-radius:8px;
  display:none;
}
#bulkInput{
  width:100%;
  min-height:280px;
  padding:18px;
  border-radius:14px;
  border:2px solid #0ea5e9;
  background:#0d255e;
  color:#22c55e;
  font-family:monospace;
  font-size:15px;
  line-height:1.6;
  resize:vertical;
}
</style>
</head>

<body>

<div class="container">
<h1>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>

<div class="top-bar">
<button class="back-btn" onclick="window.location.href='./admin.html'">
â¬… Ø±Ø¬ÙˆØ¹
</button>
  <div>
    <input type="text" id="searchInput" class="search" placeholder="ğŸ” Ø¨Ø­Ø«">
    <select id="categoryFilter" class="search">
  <option value="all">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
</select>
    <button class="add-btn" onclick="openModal()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
  </div>
</div>

<div class="table">
<div class="table-header">
  <div>Order</div>
  <div>Ø§Ù„ØµÙˆØ±Ø©</div>
  <div>Ø§Ù„Ø§Ø³Ù…</div>
  <div>Ø§Ù„Ø³Ø¹Ø±</div>
  <div>Ø§Ù„ØªØµÙ†ÙŠÙ</div>
  <div>Ø§Ù„Ø­Ø§Ù„Ø©</div>
  <div>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</div>
</div>
  <div id="productsContainer"></div>
</div>
</div>

<!-- Modal -->
<div class="modal" id="productModal">
  <div class="modal-content">
<h3 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3>

<input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
<input type="number" id="pPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
<input type="text" id="pCategory" placeholder="Ø§Ù„ØªØµÙ†ÙŠÙ">
<input type="text" id="pImage" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
<input type="text" id="pUse" placeholder="ÙˆØµÙ Ù‚ØµÙŠØ±">

<select id="pBadge">
  <option value="">Ø¨Ø¯ÙˆÙ† Badge</option>
  <option value="Original">Original</option>
  <option value="New">New</option>
  <option value="Popular">Popular</option>
  <option value="Student">Student</option>
</select>

<label style="display:flex;align-items:center;gap:8px;">
  <input type="checkbox" id="pStock" checked>
  In Stock
</label>

<button class="add-btn" onclick="saveProduct()">Ø­ÙØ¸</button>
<button onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
<hr>

<h4>ğŸš€ Developer Bulk Mode</h4>

<textarea id="bulkInput" 
  placeholder='[
 { name:"Arduino UNO", price:450, category:"Arduino" },
 { name:"MQ-2", price:100, category:"Sensors" }
]' 
  style="height:120px; padding:10px; border-radius:10px;"></textarea>

<button onclick="bulkUpload()" 
  style="background:#111;color:#fff;padding:10px;border-radius:10px;">
  Bulk Upload
</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore,
  collection,
  onSnapshot,
  addDoc,
  deleteDoc,
  updateDoc,
  doc,
  serverTimestamp,
  getDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

import { 
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA2ff2ZaA-Xb_zQcVSUDaERS-glaFFR0TY",
  authDomain: "kimo-tech-store-962df.firebaseapp.com",
  projectId: "kimo-tech-store-962df",
  storageBucket: "kimo-tech-store-962df.firebasestorage.app",
  messagingSenderId: "845478890277",
  appId: "1:845478890277:web:3cdd3328bde1b5b9dda8cc"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentRole = null;
let allProducts = [];
document.getElementById("searchInput").addEventListener("keyup", filterProducts);

function filterProducts(){

  const q = document.getElementById("searchInput").value.toLowerCase();
  const selectedCategory = document.getElementById("categoryFilter").value;

  const filtered = allProducts.filter(p=>{

    const matchesSearch =
      p.name?.toLowerCase().includes(q) ||
      p.category?.toLowerCase().includes(q) ||
      p.badge?.toLowerCase().includes(q);

    const matchesCategory =
      selectedCategory === "all" || p.category === selectedCategory;

    return matchesSearch && matchesCategory;
  });

  renderProducts(filtered);
}
document.getElementById("categoryFilter").addEventListener("change", function(){
  filterProducts();
});

let editId = null;

/* ================= Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© ================= */

onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.href = "admin-login.html";
    return;
  }

  const userDoc = await getDoc(doc(db,"users",user.uid));

  if(!userDoc.exists()){
    window.location.href = "admin-login.html";
    return;
  }

  currentRole = userDoc.data().role;

  if(currentRole !== "owner"){
    alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„");
    window.location.href = "dashboard.html";
    return;
  }

  startProductsListener();
});

/* ================= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ================= */

function startProductsListener(){

  onSnapshot(collection(db,"products"), async snapshot=>{

    allProducts = [];

    snapshot.forEach(docSnap=>{
      allProducts.push({
        id: docSnap.id,
        ...docSnap.data()
      });
    });

    // ğŸ”¥ Ù†Ø­Ø· order = 9999 Ù„Ù„Ù‚Ø¯ÙŠÙ… (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
    for(const p of allProducts){
      if(p.order === undefined){
        await updateDoc(doc(db,"products",p.id),{
          order: 9999
        });
      }
    }

    // ğŸ”¥ Ù‡Ù†Ø§ Ø¨Ù‚Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­
    allProducts.sort((a,b)=>{
      if(a.order === b.order){
        return (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
      }
      return (a.order || 9999) - (b.order || 9999);
    });

    renderProducts(allProducts);
    populateCategories();

  });
}

function populateCategories(){
  const select = document.getElementById("categoryFilter");

  const categories = [...new Set(allProducts.map(p=>p.category).filter(Boolean))];

  select.innerHTML = `<option value="all">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>`;

  categories.forEach(cat=>{
    select.innerHTML += `<option value="${cat}">${cat}</option>`;
  });
}

function renderProducts(list){

  const container = document.getElementById("productsContainer");
  container.innerHTML = "";

  list.forEach(p=>{

    container.innerHTML += `
  <div class="table-row">

<div>
  <input 
    type="number" 
    value="${p.order ?? 9999}" 
    style="width:70px;padding:5px;border-radius:6px;border:1px solid #ccc;"
    onchange="updateOrder('${p.id}', this.value)"
  >
</div>
    <div>
      <img src="${p.image || 'https://via.placeholder.com/60'}"
      style="width:60px;height:60px;object-fit:cover;border-radius:10px;">
    </div>

        <div>
          ${p.name}
          ${p.badge ? `<span class="badge">${p.badge}</span>` : ``}
        </div>

        <div>${p.price ? p.price + ' EGP' : 'â€”'}</div>
        <div>${p.category || '-'}</div>

        <div class="${p.inStock ? 'stock-yes':'stock-no'}">
          ${p.inStock ? 'In Stock':'Out'}
        </div>

        <div>
          <button class="action-btn toggle" onclick="toggleStock('${p.id}',${p.inStock})">Toggle</button>
          <button class="action-btn edit" onclick="editProduct('${p.id}')">Edit</button>
          <button class="action-btn delete" onclick="deleteProduct('${p.id}')">ğŸ—‘</button>
        </div>
      </div>
    `;
  });

}


window.deleteProduct = async function(id){
  if(!confirm("Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
  await deleteDoc(doc(db,"products",id));
  showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
}

window.toggleStock = async function(id,current){
  await updateDoc(doc(db,"products",id),{
    inStock: !current
  });
  showToast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«");
}




window.editProduct = function(id){
  const p = allProducts.find(x=>x.id===id);
  editId = id;

  document.getElementById("modalTitle").innerText = "ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬";

  document.getElementById("pName").value = p.name || "";
  document.getElementById("pPrice").value = p.price || "";
  document.getElementById("pCategory").value = p.category || "";
  document.getElementById("pImage").value = p.image || "";
  document.getElementById("pUse").value = p.use || "";
  document.getElementById("pBadge").value = p.badge || "";
  document.getElementById("pStock").checked = p.inStock ?? true;

  document.getElementById("productModal").style.display = "flex";
}

window.openModal = function(){
  editId = null;
  document.getElementById("modalTitle").innerText = "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬";
  resetForm();
  document.getElementById("productModal").style.display = "flex";
}

window.closeModal = function(){
  editId = null;
  document.getElementById("productModal").style.display="none";
}

window.saveProduct = async function(){

  const name = document.getElementById("pName").value.trim();
  const price = Number(document.getElementById("pPrice").value);
  const category = document.getElementById("pCategory").value.trim();
  const image = document.getElementById("pImage").value.trim();
  const use = document.getElementById("pUse").value.trim();
  const badge = document.getElementById("pBadge").value.trim();
  const inStock = document.getElementById("pStock").checked;

  if(!name || price <= 0){
    alert("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø± Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†");
    return;
  }

  try{

    if(editId){
      await updateDoc(doc(db,"products",editId),{
        name,
        price,
        category,
        image,
        use,
        badge,
        inStock
      });
      showToast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…","success");
    }else{
await addDoc(collection(db,"products"),{
  name,
  price,
  category,
  image,
  use,
  description: use,
  badge,
  inStock,
  order: 9999, // ğŸ‘ˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯
  createdAt: serverTimestamp()
});
      showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…","success");
    }

    // ğŸ‘‡ Ù‡Ù†Ø§ Ø§Ù„Ø³Ø±
    editId = null;
    resetForm();
    closeModal();

  }catch(error){
    console.error(error);
    showToast("ÙÙŠ Ù…Ø´ÙƒÙ„Ø© âŒ","error");
  }
}
window.bulkUpload = async function(){

  const raw = document.getElementById("bulkInput").value.trim();

  if(!raw){
    alert("Ø­Ø· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ÙˆÙ„");
    return;
  }

  let products;

  try{
    products = eval(raw); // Ù†Ø­ÙˆÙ„ Ø§Ù„Ù†Øµ Ù„ÙƒÙˆØ¯
  }catch(err){
    alert("ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØµÙŠØºØ© âŒ");
    return;
  }

  if(!Array.isArray(products)){
    alert("Ù„Ø§Ø²Ù… ØªØ¨Ø¹Øª Array Ù…Ø´ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯");
    return;
  }

  try{

    for(const p of products){

     await addDoc(collection(db,"products"),{
  name: p.name,
  price: Number(p.price),
  category: p.cat || p.category || "",
  image: p.img || "",
  use: p.use || "",
  description: p.use || "",
  badge: p.badge || "",
  inStock: true,
  order: 9999, // ğŸ‘ˆ Ù…Ù‡Ù…
  createdAt: serverTimestamp()
});

    }

    showToast("ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ğŸ”¥","success");

    document.getElementById("bulkInput").value = "";

  }catch(error){
    console.error(error);
    showToast("Ø­ØµÙ„ Ø®Ø·Ø£ âŒ","error");
  }
}
function resetForm(){
  document.getElementById("pName").value = "";
  document.getElementById("pPrice").value = "";
  document.getElementById("pCategory").value = "";
  document.getElementById("pImage").value = "";
  document.getElementById("pUse").value = "";
  document.getElementById("pBadge").value = "";
  document.getElementById("pStock").checked = true;
}
</script>

</body>
</html>