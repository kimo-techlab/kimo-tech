<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard | KIMO TECH</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<style>

body{
  margin:0;
  font-family:'Cairo',sans-serif;
  background:#f1f5f9;
}

.container{
  max-width:1200px;
  margin:30px auto;
  padding:20px;
}

h1{text-align:center;margin-bottom:30px;}

.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.card{
  background:#fff;
  padding:20px;
  border-radius:16px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  text-align:center;
}

.filters{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:20px;
}

select,input{
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
}

.order-card{
  background:#fff;
  padding:20px;
  border-radius:16px;
  margin-bottom:15px;
  box-shadow:0 6px 15px rgba(0,0,0,.05);
}

.status{
  padding:5px 10px;
  border-radius:20px;
  font-size:12px;
  color:#fff;
}

.pending{background:#f59e0b;}
.shipped{background:#3b82f6;}
.completed{background:#22c55e;}

button{
  padding:5px 8px;
  border:none;
  border-radius:8px;
  font-size:12px;
  cursor:pointer;
}

</style>
</head>


<body>



<div class="container">

<h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… KIMO ğŸ‘‘</h1>

<div class="dashboard">
  <div class="card">
    <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
    <h2 id="totalOrders">0</h2>
  </div>

  <div class="card">
    <h3>Pending</h3>
    <h2 id="pendingCount">0</h2>
  </div>

  <div class="card">
    <h3>Completed</h3>
    <h2 id="completedCount">0</h2>
  </div>

  <div class="card">
    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h3>
    <h2 id="totalRevenue">0 EGP</h2>
  </div>
</div>

<div class="filters">
  <select id="statusFilter">
    <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
    <option value="pending">Pending</option>
    <option value="shipped">Shipped</option>
    <option value="completed">Completed</option>
  </select>

  <input type="date" id="fromDate">
  <input type="date" id="toDate">

  <button onclick="loadOrders()">ÙÙ„ØªØ±Ø©</button>
  <button onclick="exportExcel()">ØªØµØ¯ÙŠØ± Excel</button>
</div>

<div id="ordersContainer"></div>

</div>
<script type="module">
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

const auth = getAuth(app);

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "admin-login.html";
  }
});
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore,
  collection,
  getDocs,
  doc,
  deleteDoc,
  onSnapshot,
  updateDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA2ff2ZaA-Xb_zQcVSUDaERS-glaFFR0TY",
  authDomain: "kimo-tech-store-962df.firebaseapp.com",
  projectId: "kimo-tech-store-962df",
  storageBucket: "kimo-tech-store-962df.firebasestorage.app",
  messagingSenderId: "845478890277",
  appId: "1:845478890277:web:3cdd3328bde1b5b9dda8cc"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ================= */

const audio = new Audio("notification.mp3");

onSnapshot(collection(db,"orders"), (snapshot)=>{
  snapshot.docChanges().forEach(change=>{
    if(change.type === "added"){
      audio.play();
      loadOrders();
    }
  });
});

/* ================= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ================= */

let chartInstance = null;

window.loadOrders = async function(){

  const snapshot = await getDocs(collection(db,"orders"));

  const statusFilter = document.getElementById("statusFilter").value;
  const fromDate = document.getElementById("fromDate").value;
  const toDate = document.getElementById("toDate").value;

  let total=0;
  let revenue=0;
  let pending=0;
  let completed=0;

  const container=document.getElementById("ordersContainer");
  container.innerHTML="";

  snapshot.forEach(docSnap=>{

    const data=docSnap.data();
    const id=docSnap.id;
    const status=data.status || "pending";

    let orderDate = data.createdAt ? data.createdAt.toDate() : null;

    if(statusFilter !== "all" && status !== statusFilter) return;

    if(fromDate && orderDate && orderDate < new Date(fromDate)) return;
    if(toDate && orderDate && orderDate > new Date(toDate)) return;

    total++;

    if(status==="pending") pending++;
    if(status==="completed"){
      completed++;
      revenue += data.total;
    }

    const card=document.createElement("div");
    card.className="order-card";
    card.style.cursor="pointer";

    card.onclick = () => openOrderDetails(data,id);

    card.innerHTML=`
      <strong>${data.customerName}</strong>
      <div class="status ${status}">${status}</div>
      <div>ğŸ’° ${data.total} EGP</div>
    `;

    container.appendChild(card);
  });

  document.getElementById("totalOrders").innerText=total;
  document.getElementById("pendingCount").innerText=pending;
  document.getElementById("completedCount").innerText=completed;
  document.getElementById("totalRevenue").innerText=revenue+" EGP";
}

/* ================= ØªØµØ¯ÙŠØ± Excel ================= */

window.exportExcel = async function(){

  const snapshot = await getDocs(collection(db,"orders"));
  let csv = "Name,Phone,Total,Status\n";

  snapshot.forEach(doc=>{
    const d = doc.data();
    csv += `${d.customerName},${d.phone},${d.total},${d.status || "pending"}\n`;
  });

  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "orders.csv";
  a.click();
}

/* ================= Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 30 ÙŠÙˆÙ… ================= */

async function autoDeleteOldOrders(){

  const snapshot = await getDocs(collection(db,"orders"));
  const now = new Date();

  snapshot.forEach(async (docSnap)=>{
    const data = docSnap.data();
    if(!data.createdAt) return;

    const orderDate = data.createdAt.toDate();
    const diff = (now - orderDate) / (1000*60*60*24);

    if(diff > 30){
      await deleteDoc(doc(db,"orders",docSnap.id));
    }
  });
}

autoDeleteOldOrders();
loadOrders();

window.openOrderDetails = function(data,id){

  let itemsHTML = "";
  data.items.forEach(p=>{
    itemsHTML += `
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
        <span>${p.name}</span>
        <span>${p.price} EGP</span>
      </div>
    `;
  });

  document.getElementById("popupContent").innerHTML = `
    <h3>${data.customerName}</h3>
    <p>ğŸ“ ${data.phone}</p>
    <p>ğŸ“ ${data.address}</p>
    <p>ğŸ’³ ${data.paymentMethod}</p>
    <hr>
    ${itemsHTML}
    <hr>
    <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${data.total} EGP</strong>

    <div style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap;">
      <button onclick="changeStatus('${id}','pending')">Pending</button>
      <button onclick="changeStatus('${id}','shipped')">Shipped</button>
      <button onclick="changeStatus('${id}','completed')">Completed</button>
      <button onclick="printOrder()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
  `;

  document.getElementById("orderPopup").style.display="flex";
}


window.changeStatus = async function(id,newStatus){

  await updateDoc(doc(db,"orders",id),{
    status:newStatus
  });

  loadOrders();
  closePopup();
}

window.closePopup = function(){
  document.getElementById("orderPopup").style.display="none";
}

window.printOrder = function(){
  const content = document.getElementById("popupContent").innerHTML;

  const printWindow = window.open("", "", "width=800,height=600");
  printWindow.document.write(`
    <html>
    <head>
      <title>Print Order</title>
      <style>
        body{font-family:Arial;padding:20px;}
      </style>
    </head>
    <body>
      ${content}
    </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.print();
}

</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<canvas id="salesChart" style="max-width:400px;margin:30px auto;"></canvas>

<div id="orderPopup" style="
display:none;
position:fixed;
inset:0;
background:rgba(0,0,0,.6);
z-index:9999;
justify-content:center;
align-items:center;
">

<div style="
background:#fff;
width:90%;
max-width:600px;
padding:25px;
border-radius:20px;
position:relative;
">

<span onclick="closePopup()" 
style="position:absolute;top:10px;left:15px;cursor:pointer;font-size:18px;">
âœ–
</span>

<div id="popupContent"></div>

</div>
</div>
</body>
</html>
